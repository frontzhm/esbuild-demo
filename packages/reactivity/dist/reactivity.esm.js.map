{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/reactive.ts"],
  "sourcesContent": ["// track\u7684\u65F6\u5019\uFF0C\u9700\u8981\u62FF\u5230effect\uFF0C\u6240\u4EE5\u7528\u4E0B\u5168\u5C40\u53D8\u91CF\u5B58\u653Eeffect\nexport let activeEffect: ReactiveEffect | null = null;\n// \u5EFA\u7ACB\u7C7B\uFF0C\u65B9\u4FBF\u5B58\u653Efn\uFF0C\u548C\u8FD0\u884C\n/**\n * fn\u662F\u51FD\u6570\uFF0C\u6536\u96C6\u5C5E\u6027\u4F9D\u8D56\uFF0Cscheduler\u662F\u51FD\u6570\uFF0C\u5C5E\u6027\u4F9D\u8D56\u53D8\u5316\u7684\u65F6\u5019\uFF0C\u6267\u884C\n * \u5C5E\u6027deps\u662F\u4E2A\u4E8C\u7EF4\u6570\u7EC4\uFF0C\u7ED3\u6784\u662F [[_effect1,_effect2],[_effect3,_effect2],]\n */\nexport class ReactiveEffect {\n  // \u662F\u5426\u4E3B\u52A8\u6267\u884C\n  private active = true\n  // \u65B0\u589Edeps\n  deps = []\n  parent\n  constructor(private fn, public scheduler) {\n  }\n\n  run() {\n    if (!this.active) {\n      const res = this.fn()\n      // \u8FD9\u91CCwatch\u7684\u65F6\u5019\uFF0Cfn\u662F\u51FD\u6570\u8FD4\u56DE\u5B57\u6BB5\uFF0C\u9700\u8981\u8FD4\u56DE\u503C\n      return res;\n    }\n\n    this.parent = activeEffect\n    activeEffect = this;\n    // \u8FD0\u884C\u4E4B\u524D\uFF0C\u6E05\u9664\u4F9D\u8D56\n    clearupEffect(this);\n    const res = this.fn();\n    activeEffect = this.parent\n    this.parent && (this.parent = null);\n    return res\n  }\n  stop() {\n    if (this.active) {\n      // \u6E05\u9664\u4F9D\u8D56\n      clearupEffect(this);\n      // \u6807\u8BB0\u4E0D\u4E3B\u52A8\u6267\u884C\n      this.active = false;\n\n    }\n  }\n\n\n\n}\n\n// \u6E05\u9664\u4F9D\u8CF4\nfunction clearupEffect(_effect) {\n  // deps\u7ED3\u6784\u662F [[_effect1,_effect2],[_effect3,_effect2],]\uFF0C\u5047\u8BBE\u53BB\u6389_effect2\n  const deps = _effect.deps\n  for (let i = 0; i < deps.length; i++) {\n    deps[i].delete(_effect)\n  }\n  // \u540C\u65F6deps\u7F6E\u7A7A\uFF0C\u4FDD\u8BC1\u6BCF\u6B21effect\u8FD0\u884C\u90FD\u662F\u65B0\u7684\u5C5E\u6027\u6620\u5C04\n  _effect.deps.length = 0\n}\n\n\n\n// }\nexport function effect(fn, options) {\n  const _effect = new ReactiveEffect(fn, options?.scheduler);\n  _effect.run();\n  // runner\u662F\u4E2A\u51FD\u6570\uFF0C\u7B49\u540C\u4E8E_effect.run\uFF0C\u6CE8\u610F\u7ED1\u5B9Athis\n  const runner = _effect.run.bind(_effect)\n  // runner\u8FD8\u6709effect\u5C5E\u6027\uFF0C\u76F4\u63A5\u8D4B\u503C\u5C31\u597D\n  runner.effect = _effect\n  return runner\n}\n\n// \u672C\u8D28\u662F\u627E\u5230\u5C5E\u6027\u5BF9\u5E94\u7684effect\uFF0C\u4F46\u5C5E\u6027\u5B58\u5728\u4E8E\u5BF9\u8C61\u91CC\uFF0C\u6240\u4EE5\u4E24\u5C42\u6620\u5C04\n// \u54CD\u5E94\u6027\u5BF9\u8C61 \u548C effect\u7684\u6620\u5C04\uFF0C\u5BF9\u8C61\u5C5E\u6027\u548Ceffect\u7684\u6620\u5C04\n// targetMap = { obj:{name:[effect],age:[effect]} }\nexport const targetMap: WeakMap<object, Map<string, Set<ReactiveEffect>>> = new WeakMap();\n\n// \u8BA9\u5C5E\u6027 \u8BA2\u9605 \u548C\u81EA\u5DF1\u76F8\u5173\u7684effect\uFF0C\u5EFA\u7ACB\u6620\u5C04\u5173\u7CFB\nexport function track(target, key) {\n  if (!activeEffect) {\n    return;\n  }\n  let depsMap = targetMap.get(target);\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map()));\n  }\n  let dep = depsMap.get(key);\n  if (!dep) {\n    depsMap.set(key, (dep = new Set()));\n  }\n  trackEffects(dep)\n}\n\n/**\n * dep\u6536\u96C6effect\n */\nexport function trackEffects(dep: Set<ReactiveEffect>) {\n  if (activeEffect && !dep.has(activeEffect)) {\n    // \u6536\u96C6effect\n    dep.add(activeEffect)\n    // effect\u540C\u6837\u6536\u96C6\u4E0Bdep\n    // @ts-ignore\n    activeEffect?.deps?.push(dep)\n  }\n}\n/**\n * dep\u6267\u884C\u89E6\u53D1effect\n */\nexport function triggerEffects(dep: Set<ReactiveEffect>) {\n  [...dep].forEach((effect) => {\n    const isRunning = activeEffect === effect\n    if (!isRunning) {\n      effect.scheduler ? effect.scheduler() : effect.run()\n    }\n  });\n}\n\n// \u5C5E\u6027\u503C\u53D8\u5316\u7684\u65F6\u5019\uFF0C\u8BA9\u76F8\u5E94\u7684effect\u6267\u884C\nexport function trigger(target, key) {\n  const depsMap = targetMap.get(target);\n  if (!depsMap) {\n    return;\n  }\n  const dep = depsMap.get(key);\n  if (!dep) {\n    return;\n  }\n  // \u89E6\u53D1\u6267\u884C\n  triggerEffects(dep)\n}\n", "// import { isObject } from './shared'\nimport { track, trigger } from './effect';\nexport const isObject = (param) => {\n  return typeof param === 'object' && param !== null\n}\nexport const isFunction = (param) => {\n  return typeof param === 'function';\n}\nconst __v_isReactive = '__v_isReactive'\n// \u662F\u4E0D\u662F\u54CD\u5E94\u5F0F\u5BF9\u8C61\nexport const isReactive = (param) => param[__v_isReactive];\n\n// \u4EE3\u7406\u5BF9\u8C61\u7684\u6620\u5C04\nexport const reactiveMap = new WeakMap()\n\nexport function reactive(target) {\n  // \u5982\u679C\u4E0D\u662F\u5BF9\u8C61\uFF0C\u76F4\u63A5\u8FD4\u56DE\n  if (!isObject(target)) {\n    return\n  }\n\n  // \u5982\u679C\u5DF2\u7ECF\u4EE3\u7406\u8FC7\u4E86\uFF0C\u76F4\u63A5\u8FD4\u56DE\n  if (reactiveMap.has(target)) {\n    return reactiveMap.get(target)\n  }\n\n  // \u5982\u679C\u5DF2\u7ECF\u4EE3\u7406\u8FC7\u4E86\uFF0C__v_isReactive\u80AF\u5B9A\u662Ftrue\uFF0C\u90A3\u76F4\u63A5\u8FD4\u56DE\n  if (target[__v_isReactive]) {\n    return target\n  }\n  // \u5982\u679C\u662Fref\u5BF9\u8C61\uFF0C\u76F4\u63A5\u8FD4\u56DEvalue\n  if (target.__v_isRef) {\n    return target.value\n  }\n\n  const proxy = new Proxy(target, {\n    get(target, key, receiver) {\n      // \u8FD9\u91CC\u57CB\u70B9\uFF0C\u52A0\u4E0A__v_isReactive\u5C5E\u6027\uFF0C\u6807\u8BC6\u5DF2\u7ECF\u4EE3\u7406\u8FC7\u4E86\n      if (key === __v_isReactive) {\n        return true\n      }\n      // Reflect\u5C06target\u7684get\u65B9\u6CD5\u91CC\u7684this\u6307\u5411proxy\u4E0A\uFF0C\u4E5F\u5C31\u662Freceiver\n      const res = Reflect.get(target, key, receiver);\n      // \u4F9D\u8D56\u6536\u96C6\n      track(target, key)\n      // \u5982\u679C\u662F\u5BF9\u8C61\uFF0C\u9012\u5F52\u4EE3\u7406\n      if(isObject(res)) {\n        return reactive(res)\n      }\n      return res;\n    },\n    set(target, key, value, receiver) {\n      const oldValue = target[key]\n      const r = Reflect.set(target, key, value, receiver);\n      // \u54CD\u5E94\u5F0F\u5BF9\u8C61\u53D1\u751F\u53D8\u5316\u7684\u65F6\u5019\uFF0C\u89E6\u53D1effect\u6267\u884C\n      if(oldValue !== value) {\n        trigger(target, key)\n      }\n      return r;\n    },\n  })\n  // \u5982\u679C\u6CA1\u6709\u4EE3\u7406\u8FC7\uFF0C\u7F13\u5B58\u6620\u5C04\n  reactiveMap.set(target, proxy)\n  return proxy\n}"],
  "mappings": "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",
  "names": ["res", "effect", "target"]
}
